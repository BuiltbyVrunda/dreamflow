{% extends "base.html" %}

{% block title %}Emergency Contacts - Sylvie{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sylvie-neumorphic.css') }}">
{% endblock %}

{% block content %}

<body class="sylvie-theme">
    <!-- Floating Elements -->
    <div class="sylvie-floating-elements">
        <svg class="sylvie-float" width="40" height="40" viewBox="0 0 100 100"
            style="top: 20%; left: 8%; animation: sylvieFloat1 7s ease-in-out infinite;">
            <path
                d="M50 25 C35 25, 25 35, 25 50 C25 65, 35 75, 50 75 C65 75, 75 65, 75 50 C75 35, 65 25, 50 25 Z M50 40 C45 40, 40 45, 40 50 C40 55, 45 60, 50 60 C55 60, 60 55, 60 50 C60 45, 55 40, 50 40 Z"
                fill="#FFB6C1" stroke="#FFB6C1" stroke-width="2" />
        </svg>
        <svg class="sylvie-float" width="35" height="35" viewBox="0 0 100 100"
            style="top: 60%; right: 12%; animation: sylvieFloat2 6s ease-in-out infinite;">
            <path d="M50 20 L60 45 L85 50 L60 55 L50 80 L40 55 L15 50 L40 45 Z" fill="#E6B5C7" stroke="#E6B5C7"
                stroke-width="2" />
        </svg>
    </div>

    <div class="sylvie-container">
        <!-- Hero Section -->
        <div class="text-center mb-4">
            <h1 class="sylvie-title sylvie-title-lg">Emergency Contacts</h1>
            <p class="sylvie-subtitle">Manage your trusted contacts for emergency alerts</p>
        </div>

        <!-- Warning Alert -->
        {% if contacts|length < 3 %} <div class="sylvie-alert sylvie-alert-warning mb-4">
            <h5 class="mb-2">‚ö†Ô∏è Add at least 3 emergency contacts</h5>
            <p class="mb-0">You need at least 3 emergency contacts to use the SOS feature. These contacts will be
                notified immediately when you trigger an emergency alert.</p>
    </div>
    {% endif %}

    <!-- Add Contact Button -->
    <div class="text-center mb-4">
        <button class="sylvie-btn sylvie-btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
            ‚ûï Add Emergency Contact
        </button>
    </div>

    <!-- Contacts List -->
    <div class="row g-3">
        {% if contacts %}
        {% for contact in contacts %}
        <div class="col-md-6">
            <div class="sylvie-card sylvie-card-compact">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="status-badge"
                            style="background: {% if contact.priority == 1 %}#B0143A{% elif contact.priority == 2 %}#FF8A7A{% elif contact.priority == 3 %}#5A8ED9{% else %}#A9E34B{% endif %}; color: white;">
                            Priority {{ contact.priority }}
                        </span>
                        <span class="status-badge"
                            style="background: rgba(10, 26, 79, 0.1); color: var(--sylvie-deep-blue);">
                            {{ contact.relationship }}
                        </span>
                    </div>
                </div>
                <h5 class="sylvie-title">{{ contact.name }}</h5>
                <p class="sylvie-subtitle mb-3">üì± {{ contact.phone }}</p>
                <div class="d-flex gap-2">
                    <button class="sylvie-btn sylvie-btn-secondary btn-sm"
                        onclick="editContact({{ contact.id }}, '{{ contact.name }}', '{{ contact.phone }}', '{{ contact.relationship }}', {{ contact.priority }})">
                        Edit
                    </button>
                    <button class="sylvie-btn sylvie-btn-primary btn-sm" onclick="deleteContact({{ contact.id }})">
                        Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="sylvie-card text-center py-5">
                <h5 class="sylvie-subtitle">No contacts added yet</h5>
                <p class="sylvie-subtitle">Add your first emergency contact to get started</p>
            </div>
        </div>
        {% endif %}
    </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header"
                    style="background: linear-gradient(145deg, var(--sylvie-berry-red), #8E0F2E); color: white;">
                    <h5 class="modal-title" id="modalTitle">Add Emergency Contact</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="background: var(--sylvie-cream);">
                    <form id="contactForm" onsubmit="saveContact(event)">
                        <input type="hidden" id="contactId" value="">

                        <div class="mb-3">
                            <label for="contactName" class="form-label sylvie-title">Name *</label>
                            <input type="text" class="form-control sylvie-input" id="contactName" required
                                maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="contactPhone" class="form-label sylvie-title">Phone Number *</label>
                            <input type="tel" class="form-control sylvie-input" id="contactPhone" required
                                pattern="[0-9+\-\s()]+" title="Please enter a valid phone number" maxlength="20">
                            <small class="sylvie-subtitle">Include country code if international (e.g., +91
                                9876543210)</small>
                        </div>

                        <div class="mb-3">
                            <label for="contactRelationship" class="form-label sylvie-title">Relationship *</label>
                            <select class="form-select sylvie-input" id="contactRelationship" required>
                                <option value="">Select relationship...</option>
                                <option value="Mother">Mother</option>
                                <option value="Father">Father</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Friend">Friend</option>
                                <option value="Colleague">Colleague</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="contactPriority" class="form-label sylvie-title">Priority (1-4) *</label>
                            <select class="form-select sylvie-input" id="contactPriority" required>
                                <option value="1">Priority 1 (Highest)</option>
                                <option value="2">Priority 2</option>
                                <option value="3">Priority 3</option>
                                <option value="4">Priority 4</option>
                            </select>
                            <small class="sylvie-subtitle">Priority determines notification order during
                                emergencies</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="sylvie-btn sylvie-btn-primary">Save Contact</button>
                            <button type="button" class="sylvie-btn sylvie-btn-secondary"
                                data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function editContact(id, name, phone, relationship, priority) {
        document.getElementById('modalTitle').textContent = 'Edit Emergency Contact';
        document.getElementById('contactId').value = id;
        document.getElementById('contactName').value = name;
        document.getElementById('contactPhone').value = phone;
        document.getElementById('contactRelationship').value = relationship;
        document.getElementById('contactPriority').value = priority;

        const modal = new bootstrap.Modal(document.getElementById('addContactModal'));
        modal.show();
    }

    function saveContact(event) {
        event.preventDefault();

        const id = document.getElementById('contactId').value;
        const data = {
            name: document.getElementById('contactName').value,
            phone: document.getElementById('contactPhone').value,
            relationship: document.getElementById('contactRelationship').value,
            priority: parseInt(document.getElementById('contactPriority').value)
        };

        const url = id ? `/api/emergency-contacts/${id}` : '/api/emergency-contacts';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Could not save contact'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Failed to save contact. Please try again.');
            });
    }

    function deleteContact(id) {
        if (!confirm('Are you sure you want to delete this emergency contact?')) {
            return;
        }

        fetch(`/api/emergency-contacts/${id}`, {
            method: 'DELETE'
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Could not delete contact'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Failed to delete contact. Please try again.');
            });
    }

    // Reset form when modal is closed
    document.getElementById('addContactModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('contactForm').reset();
        document.getElementById('contactId').value = '';
        document.getElementById('modalTitle').textContent = 'Add Emergency Contact';
    });
</script>
{% endblock %}